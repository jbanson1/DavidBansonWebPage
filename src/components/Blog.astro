---
/**
 * Changelog: Restored blog link hover glow and hardened Medium feed links with guid fallback.
 */
import Card from "./Card/index.astro";

const username = "daveitt";
let posts = [];

try {
  const res  = await fetch(`https://medium.com/feed/@${username}`);
  const xml  = await res.text();

  const items = xml.match(/<item>[\s\S]*?<\/item>/g) ?? [];
  // Note: slice(0, 2) selects only the first two posts
  posts = items.slice(0, 2).map((item) => {
    const title = item.match(/<title><!\[CDATA\[(.*?)\]\]><\/title>/)?.[1]
      ?? item.match(/<title>(.*?)<\/title>/)?.[1]
      ?? "Untitled";
    let link  = item.match(/<link>(.*?)<\/link>/)?.[1] ?? "";
    if (!link || link === "#") {
      link = item.match(/<guid.*?>(.*?)<\/guid>/)?.[1] ?? "";
    }
    if (link && !/^https?:\/\//i.test(link)) {
      link = `https://${link.replace(/^\/+/, "")}`;
    }
    const pub   = item.match(/<pubDate>(.*?)<\/pubDate>/)?.[1];
    const date  = pub
      ? new Date(pub).toLocaleDateString(undefined, {
          year: "numeric",
          month: "short",
          day: "2-digit",
        })
      : "";
    return { title, link, date };
  });
} catch (err) {
  posts = [];
}
---

<Card colSpan="md:col-span-1" rowSpan="md:row-span-3" title="Blog">
  {posts.length > 0 ? (
    <ul class="space-y-3">
      {posts.map((post) => (
        <li>
          <a
            href={post.link}
            target="_blank"
            rel="noopener noreferrer"
            class="blog-link text-sm"
          >
            {post.title}
          </a>
          {post.date && (
            <div class="text-xs text-muted">{post.date}</div>
          )}
        </li>
      ))}
    </ul>
  ) : (
    <p class="text-sm text-muted">
      No recent posts found.
      <a
        href={`https://medium.com/@${username}`}
        target="_blank"
        rel="noopener noreferrer"
        class="underline hover:text-red-500 transition-colors duration-200"
      >
        View all on Medium
      </a>.
    </p>
  )}
</Card>

<style>
  /* Blog link hover/focus glow scoped to Blog card */
  .blog-link {
    position: relative;
    display: inline-block;
    color: inherit;
    text-decoration: none;
    transition: color 160ms ease, text-shadow 160ms ease;
  }

  @media (prefers-reduced-motion: reduce) {
    .blog-link {
      transition: none;
    }
  }

  .blog-link:hover,
  .blog-link:focus-visible {
    color: var(--color-accent);
    text-shadow: 0 0 8px rgba(230, 57, 70, 0.45);
    text-shadow: 0 0 8px color-mix(in srgb, var(--color-accent) 70%, transparent);
  }

  .blog-link:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 3px;
    border-radius: 2px;
  }
</style>
